<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¢é€šç¥­æ ¸éŠ·æƒæ</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        html, body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            width: 100%; height: 100%;
            overflow: hidden;
        }

        /* --- ç›¸æ©Ÿå…¨è¢å¹• --- */
        #qr-reader {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; background: #000;
        }
        #qr-reader video {
            width: 100% !important; height: 100% !important; object-fit: cover !important;
        }

        /* --- ä»‹é¢åœ–å±¤ --- */
        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 40px 20px;
            padding-bottom: env(safe-area-inset-bottom, 40px);
            box-sizing: border-box;
            pointer-events: none;
        }

        /* --- 1. å•Ÿå‹•æŒ‰éˆ•ä»‹é¢ --- */
        #state-start { 
            background: #000; z-index: 20; pointer-events: auto;
            justify-content: center; text-align: center;
        }
        .btn-group { display: flex; flex-direction: column; gap: 20px; width: 100%; align-items: center; }
        
        .start-btn {
            background: #1B9A4B; color: white; border: none; padding: 18px 40px;
            font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(27, 154, 75, 0.5);
            width: 80%; max-width: 300px;
        }
        
        /* Bè¨ˆç•«ï¼šç³»çµ±ç›¸æ©ŸæŒ‰éˆ• */
        .file-btn {
            background: #333; color: white; border: 1px solid #555; padding: 15px 40px;
            font-size: 18px; border-radius: 50px; cursor: pointer;
            width: 80%; max-width: 300px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .file-btn::before { content: 'ğŸ“·'; }

        .start-hint { color: #888; margin-top: 20px; font-size: 14px; line-height: 1.6; }
        .reload-link { color: #666; text-decoration: underline; font-size: 14px; margin-top: 30px; cursor: pointer; }

        /* --- 2. æƒæä¸­ä»‹é¢ --- */
        #state-scanning { background: rgba(0,0,0,0.1); }
        .scan-frame {
            position: relative; width: 250px; height: 250px;
            border: 2px solid rgba(255,255,255,0.9); border-radius: 20px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.6); 
        }
        .scan-tip {
            margin-top: 20px; padding: 8px 24px;
            background: rgba(0,0,0,0.6); color: #fff; 
            border-radius: 50px; font-size: 16px; letter-spacing: 1px;
            backdrop-filter: blur(4px);
        }

        /* --- 3. è¼‰å…¥ä¸­ --- */
        #state-loading { background: rgba(0,0,0,0.85); color: white; justify-content: center; }
        .loading-spinner { font-size: 50px; animation: spin 1s infinite linear; margin-bottom: 20px; display: block; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- 4. çµæœé¡¯ç¤º --- */
        .result-card {
            width: 90%; max-width: 320px;
            padding: 30px 20px; border-radius: 20px;
            text-align: center; color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            pointer-events: auto; opacity: 0; transition: opacity 0.3s ease-out;
            background: #222;
        }
        .result-card.show { opacity: 1; }

        .card-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .success-btn { background: #219150; color: white; }
        .card-error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .error-btn { background: #962d22; color: white; }
        .card-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #222; }
        .warning-btn { background: #d35400; color: white; }
        
        .result-title { font-size: 26px; font-weight: bold; margin: 15px 0 10px 0; }
        .result-desc { font-size: 16px; line-height: 1.5; opacity: 0.95; margin-bottom: 20px;}
        .card-btn {
            width: 100%; padding: 12px 0; border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .store-footer { color: rgba(255,255,255,0.6); font-size: 14px; font-weight: bold; text-align: center; }
        .hidden { display: none !important; opacity: 0; }
        
        /* éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡† */
        #qr-input-file { display: none; }
    </style>
</head>
<body>
    <div id="qr-reader"></div>

    <div id="state-start" class="overlay-layer">
        <div style="flex:1"></div>
        <div class="btn-group">
            <button id="btn-start" class="start-btn" onclick="startScannerFresh()">å•Ÿå‹•æƒæå™¨</button>
            
            <button class="file-btn" onclick="document.getElementById('qr-input-file').click()">ä½¿ç”¨ç³»çµ±ç›¸æ©Ÿæ‹ç…§</button>
            <input type="file" id="qr-input-file" accept="image/*" capture="environment" onchange="scanFromFile(this)">
            
            <div class="start-hint" id="status-msg">
                è«‹é»æ“Šç¶ è‰²æŒ‰éˆ•é–‹å•Ÿã€‚<br>è‹¥ç„¡æ³•å•Ÿå‹•ï¼Œè«‹æ”¹ç”¨ã€Œç³»çµ±ç›¸æ©Ÿæ‹ç…§ã€ã€‚
            </div>
            <div class="reload-link" onclick="location.reload()">é é¢å¡ä½ï¼Ÿé»æ­¤é‡æ–°æ•´ç†</div>
        </div>
        <div style="flex:1"></div>
        <div class="store-footer"></div>
    </div>

    <div id="state-scanning" class="overlay-layer hidden">
        <div style="flex:1"></div>
        <div class="scan-frame"></div>
        <div class="scan-tip">è«‹å°æº–è¡Œå‹•æ¢ç¢¼</div>
        <div style="flex:1"></div>
        <div class="store-footer"></div>
    </div>

    <div id="state-loading" class="overlay-layer hidden">
        <div style="text-align: center;">
            <span class="loading-spinner">â³</span>
            <div style="font-size: 20px; font-weight:bold;">é›²ç«¯é©—è­‰ä¸­...</div>
        </div>
    </div>

    <div id="state-result" class="overlay-layer hidden" style="background: rgba(0,0,0,0.85); justify-content: center;">
        <div id="result-card-body" class="result-card">
            <div style="font-size: 60px;" id="res-icon">âœ…</div>
            <div class="result-title" id="res-title"></div>
            <div class="result-desc" id="res-desc"></div>
            <button class="card-btn" id="res-btn" onclick="resetScan()"></button>
        </div>
        <div class="store-footer" style="position: absolute; bottom: 40px;"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzhh_1BWbFNwumkrE7P3o0lwp5Ea6v9aCN3zK0DY__B3BOX_o47bAI6K5MLiMj2aF1b/exec";
    const storeName = localStorage.getItem('storeName');
    if (!storeName) { location.href = 'store-login.html'; }
    document.querySelectorAll('.store-footer').forEach(el => el.textContent = storeName);

    const states = { 
        start: document.getElementById('state-start'),
        scan: document.getElementById('state-scanning'), 
        load: document.getElementById('state-loading'), 
        result: document.getElementById('state-result')
    };
    const resultCard = document.getElementById('result-card-body');
    
    // å…¨åŸŸè®Šæ•¸
    let html5QrCode = null; 
    let isProcessing = false;

    function switchState(stateName) {
        Object.values(states).forEach(el => el.classList.add('hidden'));
        states[stateName].classList.remove('hidden');
        if (stateName === 'result') {
            setTimeout(() => resultCard.classList.add('show'), 10);
        } else {
            resultCard.classList.remove('show');
        }
    }

    function showResultCard(type, title, message) {
        const icon = document.getElementById('res-icon');
        const titleEl = document.getElementById('res-title');
        const descEl = document.getElementById('res-desc');
        const btn = document.getElementById('res-btn');
        resultCard.className = 'result-card';
        btn.className = 'card-btn';

        if (type === 'success') {
            resultCard.classList.add('card-success'); btn.classList.add('success-btn');
            icon.textContent = 'âœ…'; btn.textContent = 'æƒææˆåŠŸ';
        } else if (type === 'warning') {
            resultCard.classList.add('card-warning'); btn.classList.add('warning-btn');
            icon.textContent = 'âš ï¸'; btn.textContent = 'éŒ¯èª¤';
        } else {
            resultCard.classList.add('card-error'); btn.classList.add('error-btn');
            icon.textContent = 'âŒ'; btn.textContent = 'æƒæå¤±æ•—';
        }
        titleEl.textContent = title; descEl.innerHTML = message;
        switchState('result');
    }

    async function updateCheckin(id) {
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ id: id, storeName: storeName }) });
            return await res.json();
        } catch (e) { return { result: 'error', message: 'ç¶²è·¯é€£ç·šå¤±æ•—' }; }
    }

    async function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;
        
        // æš«åœæƒæ
        if (html5QrCode) {
            try { await html5QrCode.stop(); } catch(e){}
        }
        
        switchState('load');
        const data = await updateCheckin(decodedText);
        
        if (data.result === 'ok') {
            showResultCard('success', 'è«‹æä¾›ç†Ÿå®¢å„ªæƒ ', data.message.replace('<br>', '<div style="margin-top:8px; font-size:0.9em">') + '</div>');
        } else {
            if (data.message.includes('æœ¬åº—å·²æ ¸éŠ·')) {
                showResultCard('warning', 'æœ¬æ¢ç¢¼å·²æ ¸éŠ·é', data.message);
            } else {
                showResultCard('error', 'æœ¬è¡Œå‹•æ¢ç¢¼ç„¡æ•ˆ', data.message.replace('<br>', '<div style="margin-top:8px">') + '</div>');
            }
        }
    }

    function resetScan() { 
        // é‡ç½®æ™‚ï¼Œæˆ‘å€‘æœƒå®Œå…¨éŠ·æ¯€èˆŠçš„å¯¦ä¾‹ï¼Œç­‰å¾…ä¸‹æ¬¡æŒ‰ä¸‹å•Ÿå‹•
        // é€™æ¨£å¯ä»¥é¿å… Safari çš„ç‹€æ…‹é–æ­»å•é¡Œ
        html5QrCode = null;
        isProcessing = false;
        switchState('start'); 
    }

    // â˜…â˜…â˜… Aè¨ˆç•«ï¼šå…¨æ–°å•Ÿå‹• (è§£æ±º Safari ç‹€æ…‹å•é¡Œ) â˜…â˜…â˜…
    function startScannerFresh() {
        const btn = document.getElementById('btn-start');
        const statusMsg = document.getElementById('status-msg');
        btn.disabled = true;
        btn.textContent = "å•Ÿå‹•ä¸­...";

        // æ¯æ¬¡é»æ“Šéƒ½ new ä¸€å€‹æ–°çš„å¯¦ä¾‹ï¼Œç¢ºä¿æ²’æœ‰èˆŠç‹€æ…‹æ®˜ç•™
        html5QrCode = new Html5Qrcode("qr-reader");

        // è¨­å®šï¼šåŠ å› qrbox: 250 (è§£æ±ºéˆæ•åº¦0çš„å•é¡Œ)
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        // å•Ÿå‹•
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => {
                switchState('scan');
                btn.textContent = "å•Ÿå‹•æƒæå™¨";
                btn.disabled = false;
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.textContent = "å•Ÿå‹•å¤±æ•—";
                statusMsg.innerHTML = `<span style="color:#ff5555">å•Ÿå‹•å¤±æ•—ã€‚è«‹é»æ“Šä¸‹æ–¹çš„ã€Œä½¿ç”¨ç³»çµ±ç›¸æ©Ÿæ‹ç…§ã€ä¾†æƒæã€‚</span>`;
            });
    }

    // â˜…â˜…â˜… Bè¨ˆç•«ï¼šç³»çµ±ç›¸æ©Ÿ (Fallback) â˜…â˜…â˜…
    function scanFromFile(input) {
        if (input.files.length === 0) return;
        
        const file = input.files[0];
        isProcessing = true;
        switchState('load');

        // ä½¿ç”¨ html5-qrcode çš„æª”æ¡ˆæƒæåŠŸèƒ½
        // é€™è£¡ä¹Ÿéœ€è¦ä¸€å€‹å¯¦ä¾‹ï¼Œæˆ‘å€‘è‡¨æ™‚ new ä¸€å€‹
        const tempScanner = new Html5Qrcode("qr-reader");
        
        tempScanner.scanFile(file, true)
            .then(decodedText => {
                onScanSuccess(decodedText);
            })
            .catch(err => {
                isProcessing = false;
                switchState('start');
                alert("åœ–ç‰‡ä¸­æ‰¾ä¸åˆ° QR Codeï¼Œè«‹é‡æ‹ä¸€å¼µæ¸…æ¥šçš„ï¼Œæˆ–æ˜¯å°æº–ä¸€é»ã€‚");
            });
    }
    </script>
</body>
</html>
